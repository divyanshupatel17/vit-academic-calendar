name: PR Calendar Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'calendars/**/*.json'

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed calendar files
        id: changed
        uses: tj-actions/changed-files@v40
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          sha: ${{ github.event.pull_request.head.sha }}
          files: |
            calendars/**/*.json

      - name: Analyze calendars
        run: |
          echo "## ðŸ“… Calendar Analysis Report" > report.md
          echo "" >> report.md

          for file in ${{ steps.changed.outputs.all_changed_files }}; do
            echo "### File: \`$file\`" >> report.md
            echo "" >> report.md

            SEMESTER=$(jq -r '.semester' "$file")
            CLASS=$(jq -r '.classGroup' "$file")
            UPDATED=$(jq -r '.lastUpdated' "$file")

            echo "**Semester:** $SEMESTER" >> report.md
            echo "**Class Group:** $CLASS" >> report.md
            echo "**Last Updated:** $UPDATED" >> report.md
            echo "" >> report.md

            MATCH=""
            for base in $(git ls-tree -r --name-only origin/${{ github.base_ref }} calendars | grep '.json'); do
              git show origin/${{ github.base_ref }}:$base > /tmp/base.json || continue

              if [ "$(jq -r '.semester' /tmp/base.json)" = "$SEMESTER" ] && \
                 [ "$(jq -r '.classGroup' /tmp/base.json)" = "$CLASS" ]; then
                MATCH="$base"
                break
              fi
            done

            if [ -z "$MATCH" ]; then
              echo "**Type:** NEW CALENDAR" >> report.md
            else
              echo "**Type:** UPDATE EXISTING CALENDAR" >> report.md
              echo "**Previous File:** \`$MATCH\`" >> report.md
              echo "" >> report.md

              OLD_TOTAL=0
              for m in $(jq -r '.months | keys[]' /tmp/base.json); do
                OLD_TOTAL=$((OLD_TOTAL + $(jq -r ".months[\"$m\"].events.days | length" /tmp/base.json)))
              done

              NEW_TOTAL=0
              for m in $(jq -r '.months | keys[]' "$file"); do
                NEW_TOTAL=$((NEW_TOTAL + $(jq -r ".months[\"$m\"].events.days | length" "$file")))
              done

              echo "**Event Comparison:**" >> report.md
              echo "- Previous: $OLD_TOTAL days" >> report.md
              echo "- Current: $NEW_TOTAL days" >> report.md
              echo "- Difference: $((NEW_TOTAL - OLD_TOTAL)) days" >> report.md
            fi

            echo "" >> report.md
            echo "---" >> report.md
            echo "" >> report.md
          done

      - name: Publish PR summary
        run: |
          cat report.md >> $GITHUB_STEP_SUMMARY

