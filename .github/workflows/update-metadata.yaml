name: Update Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'calendars/**/*.json'
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Generate metadata.json
        run: |
          echo "Generating metadata.json..."
          
          TOTAL_SEMESTERS=0
          TOTAL_CALENDARS=0
          SEMESTERS_JSON="[]"
          
          for semester_dir in calendars/*/; do
            if [ -d "$semester_dir" ]; then
              SEMESTER_NAME=$(basename "$semester_dir")
              TOTAL_SEMESTERS=$((TOTAL_SEMESTERS + 1))
              
              FIRST_FILE=$(find "$semester_dir" -name "*.json" -type f | head -n 1)
              
              if [ -n "$FIRST_FILE" ]; then
                SEMESTER_FULL_NAME=$(jq -r '.semester' "$FIRST_FILE")
              else
                SEMESTER_FULL_NAME="$SEMESTER_NAME"
              fi
              
              CLASS_GROUPS_JSON="[]"
              
              for file in "$semester_dir"*.json; do
                if [ -f "$file" ]; then
                  TOTAL_CALENDARS=$((TOTAL_CALENDARS + 1))
                  
                  FILENAME=$(basename "$file")
                  CLASS_GROUP=$(jq -r '.classGroup' "$file")
                  LAST_UPDATED=$(jq -r '.lastUpdated' "$file")
                  LAST_UPDATED_ISO=$(jq -r '.lastUpdatedISO' "$file")
                  
                  MONTH_COUNT=$(jq -r '.months | keys | length' "$file")
                  MONTHS_LIST=$(jq -r '.months | keys | join(", ")' "$file")
                  
                  TOTAL_EVENTS=0
                  MONTHS=$(jq -r '.months | keys | .[]' "$file")
                  for month in $MONTHS; do
                    EVENT_COUNT=$(jq -r ".months[\"$month\"].events.days | length" "$file")
                    TOTAL_EVENTS=$((TOTAL_EVENTS + EVENT_COUNT))
                  done
                  
                  TOTAL_EVENT_ITEMS=0
                  for month in $MONTHS; do
                    DAYS=$(jq -r ".months[\"$month\"].events.days | length" "$file")
                    for ((i=0; i<$DAYS; i++)); do
                      EVENT_ITEMS=$(jq -r ".months[\"$month\"].events.days[$i].events | length" "$file")
                      TOTAL_EVENT_ITEMS=$((TOTAL_EVENT_ITEMS + EVENT_ITEMS))
                    done
                  done
                  
                  CLASS_GROUP_OBJ=$(jq -n \
                    --arg cg "$CLASS_GROUP" \
                    --arg fn "$FILENAME" \
                    --arg lu "$LAST_UPDATED" \
                    --arg lui "$LAST_UPDATED_ISO" \
                    --argjson mc "$MONTH_COUNT" \
                    --arg ml "$MONTHS_LIST" \
                    --argjson te "$TOTAL_EVENTS" \
                    --argjson tei "$TOTAL_EVENT_ITEMS" \
                    --arg fp "calendars/$SEMESTER_NAME/$FILENAME" \
                    '{
                      classGroup: $cg,
                      fileName: $fn,
                      filePath: $fp,
                      lastUpdated: $lu,
                      lastUpdatedISO: $lui,
                      monthCount: $mc,
                      months: $ml,
                      totalEventDays: $te,
                      totalEvents: $tei
                    }')
                  
                  CLASS_GROUPS_JSON=$(echo "$CLASS_GROUPS_JSON" | jq --argjson obj "$CLASS_GROUP_OBJ" '. += [$obj]')
                fi
              done
              
              SEMESTER_OBJ=$(jq -n \
                --arg sn "$SEMESTER_NAME" \
                --arg sfn "$SEMESTER_FULL_NAME" \
                --argjson cg "$CLASS_GROUPS_JSON" \
                --argjson cgc "$(echo "$CLASS_GROUPS_JSON" | jq 'length')" \
                '{
                  semesterFolder: $sn,
                  semesterName: $sfn,
                  classGroupCount: $cgc,
                  classGroups: $cg
                }')
              
              SEMESTERS_JSON=$(echo "$SEMESTERS_JSON" | jq --argjson obj "$SEMESTER_OBJ" '. += [$obj]')
            fi
          done
          
          CURRENT_TIME=$(date -u +"%B %d, %Y at %I:%M:%S %p")
          CURRENT_TIME_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          jq -n \
            --arg lu "$CURRENT_TIME" \
            --arg lui "$CURRENT_TIME_ISO" \
            --argjson ts "$TOTAL_SEMESTERS" \
            --argjson tc "$TOTAL_CALENDARS" \
            --argjson sem "$SEMESTERS_JSON" \
            '{
              lastUpdated: $lu,
              lastUpdatedISO: $lui,
              totalSemesters: $ts,
              totalCalendars: $tc,
              semesters: $sem
            }' > metadata.json
          
          echo "Metadata generated successfully"
          
      - name: Commit and push metadata
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add metadata.json
          
          if git diff --staged --quiet; then
            echo "No changes to metadata.json"
          else
            git commit -m "Update metadata.json [skip ci]"
            git push
          fi
