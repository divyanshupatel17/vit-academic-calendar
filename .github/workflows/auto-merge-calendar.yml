# GitHub Actions Workflow for Auto-Reviewing and Merging Calendar PRs
# File Location: .github/workflows/auto-merge-calendar.yml
name: Auto Review and Merge Calendar PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'calendars/**/*.json'

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            calendars/**/*.json

      - name: Validate JSON files
        id: validate
        run: |
          echo "Validating JSON files..."
          VALID=true
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking $file"

            if [ ! -f "$file" ]; then
              echo "Error: File $file not found"
              VALID=false
              continue
            fi

            if ! jq empty "$file" 2>/dev/null; then
              echo "Error: Invalid JSON in $file"
              VALID=false
              continue
            fi

            if ! jq -e '.lastUpdated and .lastUpdatedISO and .semester and .classGroup and .months' "$file" > /dev/null; then
              echo "Error: Missing fields in $file"
              VALID=false
              continue
            fi

            echo "‚úì $file is valid"
          done

          echo "valid=$VALID" >> $GITHUB_OUTPUT
          if [ "$VALID" = false ]; then exit 1; fi

      - name: Check for updates
        id: check-updates
        run: |
          HAS_UPDATES=false
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if git show origin/main:$file > /dev/null 2>&1; then
              NEW=$(jq 'del(.lastUpdated,.lastUpdatedISO)' "$file")
              OLD=$(git show origin/main:$file | jq 'del(.lastUpdated,.lastUpdatedISO)')
              if [ "$NEW" != "$OLD" ]; then HAS_UPDATES=true; fi
            else
              HAS_UPDATES=true
            fi
          done
          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT

      - name: Auto-merge PR
        if: steps.validate.outputs.valid == 'true' && steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash'
            })

      - name: Comment after merge
        if: steps.validate.outputs.valid == 'true' && steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üéâ Auto-merged successfully!'
            })

      - name: Close PR with comment (no actual changes)
        if: steps.validate.outputs.valid == 'true' && steps.check-updates.outputs.has_updates == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è Identical to main (only timestamps changed) ‚Äî closing PR.'
            })
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            })
